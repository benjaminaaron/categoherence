<!doctype html>
<html>
  <head>
    <title>Retro - Results</title>
    <script src='/socket.io/socket.io.js'></script>
    <script src="lib/main.js"></script>
    <link rel="shortcut icon" href="#">
    <link rel="stylesheet" type="text/css" href="lib/main.css">
    <style>
      html {
        padding-left: 40px;
        text-align: center;
      }
    </style>
  </head>
  <body>
    <br><br>
    <div id="people-chips"></div>
    <br><br>
    <div id="subgroups"></div>
    <script src="lib/notie.js"></script>
    <script>
      let socket = io();

      let people;
      let subgroups = {};
      let sessionData = [];

      socket.emit('login-retro-results', getSessionIdFromURL());

      function buildPerson(person) {
        let div = document.createElement('div');
        div.className = person.isGuest ? 'chip chip-guest' : 'chip';
        div.textContent = person.name;
        document.getElementById('people-chips').append(div);
        person.div = div;
        person.selected = true;
        div.classList.add('chip-selected');
        div.addEventListener('click', function() {
          if (person.selected) {
            div.classList.remove('chip-selected');
          } else {
            div.classList.add('chip-selected');
          }
          person.selected = !person.selected;
          updateSubgroups();
        });
      }

      function updateSubgroups() {
        let selectedPeopleIndices = Object.values(people).filter(p => p.selected).map(p => p.id);
        console.log("selectedPeopleIndices", selectedPeopleIndices);
        // TODO
      }

      socket.on('session-results-login-retro-response', function(session) {
        sessionData = session;
        people = session.data.entities;
        for (let guest of session.guests)
          people[guest.id] = guest;
        for (let id of Object.keys(people))
          buildPerson(people[id])
        console.log("people", people);

        updateSubgroups();

        for (let submission of Object.values(session.submissions)) {
          let indices = submission.selectedPeople;

          if (!subgroups[indices]) {
            subgroups[indices] = {
              indices: indices,
              factor: 0,
              submissions: []
            };
          }
          subgroups[indices].factor += submission.reactionCount;
          subgroups[indices].submissions.push(submission);
        }

        for (let subgroup of Object.values(subgroups)) {
          let avgReactionCount = subgroup.factor / subgroup.submissions.length;
          subgroup.factor = avgReactionCount* subgroup.indices.length * subgroup.submissions.length;
        }

        let subgroupsSorted = Object.values(subgroups).sort((a, b) => b.factor - a.factor);

        for (let subgroup of subgroupsSorted) {
          let names = "";
          for (let id of subgroup.indices)
            names += ", " + session.data.entities[id].name;
          let reactionCount = 0;
          for (let submission of subgroup.submissions)
            reactionCount += submission.reactionCount;
          let subgroupDiv = document.createElement("div");
          subgroupDiv.className = "submission";
          document.getElementById('subgroups').prepend(subgroupDiv);
          let submissionHeadlineSpan = createElement('span', subgroupDiv, '', '');
          createElement('span', submissionHeadlineSpan, names.substring(2), 'submission_names');
          createElement('span', submissionHeadlineSpan, reactionCount, 'submission_reaction');

          for (let submission of subgroup.submissions) {
            let statementDiv = document.createElement('div');
            statementDiv.className = 'submission_statement';
            statementDiv.innerHTML = '<span style="color:silver;">&#9679;</span> ' + submission.statement
            subgroupDiv.appendChild(statementDiv);
          }
        }

        let teamMembers = Object.values(session.data.entities).filter(e => !e.isGuest).length;
        let totalSubgroups = 2 ** teamMembers;
        let percentageSubgroupsUsed = (subgroupsSorted.length / totalSubgroups) * 100;

        console.log("stats", subgroupsSorted.length, totalSubgroups, percentageSubgroupsUsed + "%");
        console.log("session", session);
        console.log("subgroupsSorted", subgroupsSorted);
      });

      setupNotie(notie, socket);
    </script>
  </body>
</html>
