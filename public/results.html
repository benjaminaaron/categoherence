<!doctype html>
<html>
<head>
  <title>Retro - Results</title>
  <script src='/socket.io/socket.io.js'></script>
  <script src="lib/main.js"></script>
  <link rel="shortcut icon" href="#">
  <link rel="stylesheet" type="text/css" href="lib/main.css">
  <style>
    html {
      padding-left: 40px;
      text-align: center;
    }
  </style>
</head>
  <body>
    <script src="lib/notie.js"></script>
    <script>
      let socket = io();

      let subgroups = {};

      socket.emit('login-retro-results', getSessionIdFromURL());

      socket.on('session-results-login-retro-response', function(session) {
        for (let submission of Object.values(session.submissions)) {
          let indices = submission.selectedPeople;

          // TODO filter for selected in result chips

          if (!subgroups[indices]) {
            subgroups[indices] = {
              indices: indices,
              factor: 0,
              submissions: []
            };
          }
          subgroups[indices].factor += submission.reactionCount;
          subgroups[indices].submissions.push(submission);
        }

        for (let subgroup of Object.values(subgroups)) {
          let avgReactionCount = subgroup.factor / subgroup.submissions.length;
          subgroup.factor = avgReactionCount* subgroup.indices.length * subgroup.submissions.length;
        }

        let subgroupsSorted = Object.values(subgroups).sort((a, b) => b.factor - a.factor);
        console.log(subgroupsSorted);

        // TODO

        let teamMembers = Object.values(session.data.entities).filter(e => !e.isGuest).length;
        let totalSubgroups = 2 ** teamMembers;
        let percentageSubgroupsUsed = (subgroupsSorted.length / totalSubgroups) * 100;

        console.log("stats", subgroupsSorted.length, totalSubgroups, percentageSubgroupsUsed);
      });

      setupNotie(notie, socket);
    </script>
  </body>
</html>
