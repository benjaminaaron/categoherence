<!doctype html>
<html>
  <head>
    <title>subgroups - session</title>
    <script src='/socket.io/socket.io.js'></script>
    <script src="lib/jquery.js"></script>
    <script src="lib/main.js"></script>
    <link rel="shortcut icon" href="#">
    <link rel="stylesheet" type="text/css" href="lib/main.css">
    <style>
      html {
        padding: 40px;
      }
      .chip {
        display: inline-block;
        padding: 0 25px;
        height: 50px;
        font-size: 16px;
        line-height: 50px;
        border-radius: 25px;
        background-color: #f1f1f1;
      }
      .whole-team-chip {
        background-color: #00ff00;
      }
      .chip_selected {
        background-color: #ff0000 !important;
      }
      .chipGuest {
        display: inline-block;
        padding: 0 25px;
        height: 50px;
        font-size: 16px;
        line-height: 50px;
        border-radius: 25px;
        background-color: #ffff00;
      }
      .submission {
        padding: 0 25px;
        height: 50px;
        font-size: 16px;
        line-height: 50px;
        border-radius: 25px;
        background-color: #f1f1f1;
      }
      .reaction {
        padding-left: 50px;
      }
    </style>
  </head>
  <body>
    <div id="session-info"></div>
    <br><br>
    <div id="people-chips"><div id="whole-team-btn" class="chip whole-team-chip">whole team</div></div>
    <input type="button" value="add guest" id="add-guest-btn">
    <br><br>
    <input type="radio" id="appreciation" name="statement_types" checked="checked">
    <label for="appreciation">Appreciation</label><br>
    <input type="radio" id="amazing-at" name="statement_types">
    <label for="amazing-at">You'd be amazing at</label><br>
    <input type="radio" id="other" name="statement_types">
    <label for="other">Other</label><br>
    <br><br>
    <input type="text" id="submission-statement" value="placeholder" size="100">
    <br><br>
    <input id="submit-btn" type="submit" value="submit">
    <br><br>
    <hr>
    <br><br>
    <div id="submissions"></div>
    <script src="lib/notie.js"></script>
    <script>
      let socket = io();

      let sessionId = getSessionIdFromURL();
      let people;
      let reactionSpans = {}; // submissionId to <span>

      function buildPerson(person) {
        let div = createElement('div', document.getElementById('people-chips'),
            person.name, person.isGuest ? 'chipGuest' : 'chip');
        person.div = div;
        div.addEventListener('click', function() {
          if (person.selected) {
            div.classList.remove('chip_selected');
          } else {
            div.classList.add('chip_selected');
          }
          person.selected = !person.selected;
          updateWholeTeamButtonStyle();
        });
        // div.addEventListener('mouseover', function() {});
      }

      socket.emit('session-login', sessionId);

      socket.on('session-login-response', function(session) {
        document.getElementById('session-info').innerHTML = '<b>' + session.data.name + '</b><br>';
        people = session.data.entities;
        for (let id of Object.keys(people)) {
          buildPerson(people[id])
        }
        for (let guest of session.guests) {
          people[guest.id] = guest;
          buildPerson(guest);
        }
        for (let submission of session.submissions) {
          appendSubmissionDiv(submission);
          reactionSpans[submission.id].innerHTML = "+" + submission.reactionCount;
        }
      });

      $('#submit-btn').click(function() {
        let statement = $('#submission-statement').val();
        if (statement.trim().length === 0) {
          notie.alert({ type: 'error', text: 'No statement entered' })
          return;
        }
        let selectedPeople = Object.values(people).filter(p => p.selected).map(p => p.id);
        if (selectedPeople.length === 0) {
          notie.alert({ type: 'error', text: 'No people selected' })
          return;
        }
        let submissionData = {
          'sessionId': sessionId,
          'timestamp': getTimestamp(),
          'selectedPeople': selectedPeople,
          'statementType': getStatementType(),
          'statement': statement,
          'reactionCount': 0
        };
        socket.emit('retro-submission', submissionData);
        Object.values(people).forEach(p => {
          p.selected = false;
          p.div.classList.remove('chip_selected');
        });
        $('#submission-statement').val('');
      });

      $('#add-guest-btn').click(function() {
        let guestName = prompt("What's their name?", "");
        if (guestName == null || guestName.trim() === "") {
          notie.alert({ type: 'error', text: 'No name entered' })
          return;
        }
        socket.emit('add-guest', {
          sessionId: sessionId,
          id: null,
          name: guestName,
          div: null,
          selected: false,
          isGuest: true
        });
      });

      function wholeTeamIsSelected() {
        return Object.values(people).filter(p => !p.isGuest).every(p => p.selected) &&
            Object.values(people).filter(p => p.isGuest).every(p => !p.selected);
      }

      function updateWholeTeamButtonStyle() {
        let wholeTeamBtn = document.getElementById('whole-team-btn');
        if (wholeTeamIsSelected()) {
          wholeTeamBtn.classList.add('chip_selected');
        } else {
          wholeTeamBtn.classList.remove('chip_selected');
        }
      }

      $('#whole-team-btn').click(function() {
        if (wholeTeamIsSelected()) {
          Object.values(people).forEach(p => {
            p.selected = false;
            p.div.classList.remove('chip_selected');
          });
        } else {
          Object.values(people).forEach(p => {
            if (p.isGuest) {
              p.selected = false;
              p.div.classList.remove('chip_selected');
            } else {
              p.selected = true;
              p.div.classList.add('chip_selected');
            }
          });
        }
        updateWholeTeamButtonStyle();
      });

      function appendSubmissionDiv(submissionData) {
        let text = "";
        for (id of submissionData.selectedPeople) {
          text += ", " + people[id].name;
        }
        text = "[" + text.substring(2) + "] ";
        let submissionDiv = createElement('div', document.getElementById('submissions'),
            text + submissionData.statement, 'submission');
        let reactionSpan = createElement('span', submissionDiv, '+0', 'reaction');
        reactionSpans[submissionData.id] = reactionSpan;
        reactionSpan.addEventListener('click', function() {
          socket.emit('reaction-added', {
            sessionId: sessionId,
            submissionId: submissionData.id
          });
        });
      }

      socket.on('broadcast-retro-submission', function(submissionData) {
        appendSubmissionDiv(submissionData);
      });

      socket.on('broadcast-new-guest', function(guest) {
        people[guest.id] = guest;
        buildPerson(guest);
      });

      socket.on('broadcast-reaction-added', function(reactionData) {
        let reactionSpan = reactionSpans[reactionData.submissionId];
        reactionSpan.innerHTML = "+" + (parseInt(reactionSpan.innerHTML.substring(1)) + 1);
      });

      function getStatementType() {
        if($('#appreciation').is(':checked')) return 'appreciation';
        if($('#amazing-at').is(':checked')) return 'amazing-at';
        if($('#other').is(':checked')) return 'other';
      }
      setupNotie(notie, socket);
    </script>
  </body>
</html>
